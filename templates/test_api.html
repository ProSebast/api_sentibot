{% extends "base.html" %}
{% block title %}Dashboard Emociones{% endblock %}
{% block content %}
{% load static %}

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f2f5;
    margin: 20px;
    text-align: center;
  }

  .camara-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 auto 20px auto;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
  }

  .camara-container video {
    width: 100%;
    display: block;
  }

  .estado {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 8px 0;
    font-weight: bold;
  }

  .overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 220px;
    height: 220px;
    border: 3px solid #7ED321;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  button {
    background-color: #7ED321;
    color: white;
    border: none;
    padding: 12px 25px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    margin: 15px 10px 15px 0;
  }

  button:hover {
    background-color: #52a003;
  }

  #usuario {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
  }

  .report-box {
    background-color: #9b5f5f;
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
  }

  .foto-box img {
    width: 200px;
    height: 200px;
    border-radius: 12px;
    object-fit: cover;
  }

  #emocionEnCamara {
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 8px 18px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
  }
</style>

<h2>Inicio</h2>

<div class="camara-container">
  <video id="videoCamara" autoplay playsinline></video>
  <div class="overlay"></div>
  <div id="emocionEnCamara">Sin reconocer — 0%</div>
  <div class="estado">Apagado</div>
</div>

<div>
  <button id="startBtn">Iniciar Cámara</button>
</div>

<div id="usuario">Hombre Completo</div>

<div class="row g-4">
  <div class="col-12 col-md-6 col-lg-4 report-box">
    <h3>Reporte actual</h3>
    <p id="feliz">Feliz: 0 seg</p>
    <p id="triste">Triste: 0 seg</p>
    <p id="neutral">Neutral: 0 seg</p>
    <p id="enojado">Enojado: 0 seg</p>
    <p id="sorprendido">Sorprendido: 0 seg</p>
    <p id="sinreconocer">Sin reconocer: 0 seg</p>
  </div>

  <div class="col-12 col-md-6 col-lg-4 foto-box">
    <img src="{% static 'img/prueba.jpg' %}" id="fotoCapturada" alt="Foto Capturada">
  </div>

  <div class="col-12 col-md-6 col-lg-4 report-box">
    <h3>Informe básico</h3>
    <p id="estado">Estado: Neutral</p>
    <p id="porcentaje">Porcentaje: 0%</p>
    <p id="rostro">Estado del rostro: No detectado</p>
    <p id="sujeto">Id: ---</p>
  </div>
</div>

{% csrf_token %}

<script>
document.addEventListener("DOMContentLoaded", () => {
    const startBtn = document.getElementById('startBtn');
    const videoCamara = document.getElementById('videoCamara');
    const estadoCamara = document.querySelector('.estado');
    const fotoCapturada = document.getElementById('fotoCapturada');
    const emocionEnCamara = document.getElementById('emocionEnCamara');

    const felizEl = document.getElementById('feliz');
    const tristeEl = document.getElementById('triste');
    const neutralEl = document.getElementById('neutral');
    const enojadoEl = document.getElementById('enojado');
    const sorprendidoEl = document.getElementById('sorprendido');
    const sinreconocerEl = document.getElementById('sinreconocer');

    const estadoEl = document.getElementById('estado');
    const porcentajeEl = document.getElementById('porcentaje');
    const rostroEl = document.getElementById('rostro');
    const sujetoEl = document.getElementById('sujeto');

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    let stream = null;
    let camaraEncendida = false;
    let intervalo = null;

    let segundos = {
      Feliz: 0,
      Triste: 0,
      Neutral: 0,
      Enojado: 0,
      Sorprendido: 0,
      SinReconocer: 0
    };

    startBtn.addEventListener('click', async () => {
        if (!camaraEncendida) {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoCamara.srcObject = stream;
                estadoCamara.textContent = 'Cámara activa';
                camaraEncendida = true;
                startBtn.textContent = 'Apagar Cámara';

                // Llama a la API cada 2 segundos automáticamente
                intervalo = setInterval(() => {
                    if (camaraEncendida) capturarYPredecir();
                }, 2000);

            } catch (err) {
                console.error("Error al activar cámara:", err);
                estadoCamara.textContent = 'Error al iniciar cámara';
            }
        } else {
            // Apagar cámara
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            clearInterval(intervalo);
            videoCamara.srcObject = null;
            estadoCamara.textContent = 'Apagado';
            camaraEncendida = false;
            startBtn.textContent = 'Iniciar Cámara';
        }
    });

    function capturarYPredecir() {
        const canvas = document.createElement('canvas');
        const size = 220;
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        const vw = videoCamara.videoWidth;
        const vh = videoCamara.videoHeight;
        const sx = (vw - size) / 2;
        const sy = (vh - size) / 2;
        ctx.drawImage(videoCamara, sx, sy, size, size, 0, 0, size, size);

        const fotoBase64 = canvas.toDataURL('image/png');
        fotoCapturada.src = fotoBase64;

        fetch("{% url 'predict_emotion' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ image: fotoBase64 })
        })
        .then(res => res.json())
        .then(data => {
            let emocion = data.label || "SinReconocer";
            const confianza = data.confidence || 0;

            if (!['Feliz','Triste','Neutral','Enojado','Sorprendido'].includes(emocion)) {
                emocion = "SinReconocer";
            }

            emocionEnCamara.textContent = `${emocion} — ${(confianza * 100).toFixed(1)}%`;
            estadoEl.textContent = `Estado: ${emocion}`;
            porcentajeEl.textContent = `Porcentaje: ${(confianza * 100).toFixed(1)}%`;
            rostroEl.textContent = `Estado del rostro: Detectado`;
            sujetoEl.textContent = `Id: 001`;

            segundos[emocion] += 2;

            felizEl.textContent = `Feliz: ${segundos.Feliz} seg`;
            tristeEl.textContent = `Triste: ${segundos.Triste} seg`;
            neutralEl.textContent = `Neutral: ${segundos.Neutral} seg`;
            enojadoEl.textContent = `Enojado: ${segundos.Enojado} seg`;
            sorprendidoEl.textContent = `Sorprendido: ${segundos.Sorprendido} seg`;
            sinreconocerEl.textContent = `Sin reconocer: ${segundos.SinReconocer} seg`;
        })
        .catch(err => {
            console.error("Error predicción:", err);
            emocionEnCamara.textContent = "Error — 0%";
        });
    }
});
</script>

{% endblock %}
